---
- name: Set baseline facts
  ansible.builtin.set_fact:
    panorama_provider: "{{ provider }}"
    dg: "{{ device_group }}"
    ts: "{{ template_stack }}"

- name: Configure baseline security profile group
  paloaltonetworks.panos.panos_security_rule_group:
    provider: "{{ panorama_provider }}"
    device_group: "{{ dg }}"
    name: "{{ baseline_security_profile_group.name }}"
    virus: "{{ baseline_security_profile_group.virus }}"
    spyware: "{{ baseline_security_profile_group.spyware }}"
    vulnerability: "{{ baseline_security_profile_group.vulnerability }}"
    url_filtering: "{{ baseline_security_profile_group.url_filtering }}"
    file_blocking: "{{ baseline_security_profile_group.file_blocking }}"
    wildfire_analysis: "{{ baseline_security_profile_group.wildfire }}"
    state: present
  tags:
    - security_profiles

- name: Configure baseline zone protection profile
  paloaltonetworks.panos.panos_zone_protection_profile:
    provider: "{{ panorama_provider }}"
    device_group: "{{ dg }}"
    name: "{{ baseline_zone_protection.name }}"
    flood_tcp_syn: "{{ baseline_zone_protection.settings.flood_tcp_syn }}"
    flood_udp: "{{ baseline_zone_protection.settings.flood_udp }}"
    flood_icmpv4: "{{ baseline_zone_protection.settings.flood_icmpv4}}"
    enable_scan_protection: "{{ baseline_zone_protection.settings.scan_protection }}"
    state: present
  tags:
    - zone_protection

- name: Configure NTP servers
  paloaltonetworks.panos.panos_mgtconfig:
    provider: "{{ panorama_provider }}"
    template: "{{ ts }}"
    ntp_server_primary: "{{ baseline_ntp.primary_server }}"
    ntp_server_secondary: "{{ baseline_ntp.secondary_server }}"
  tags:
    - ntp
    - management

- name: Configure DNS servers
  paloaltonetworks.panos.panos_mgtconfig:
    provider: "{{ panorama_provider }}"
    template: "{{ ts }}"
    dns_server_primary: "{{ baseline_dns.primary_server }}"
    dns_server_secondary: "{{ baseline_dns.secondary_server }}"
  tags:
    - dns
    - management

- name: Configure admin idle timeout
  paloaltonetworks.panos.panos_mgtconfig:
    provider: "{{ panorama_provider }}"
    template: "{{ ts }}"
    admin_lockout_time: "{{ baseline_management.idle_timeout }}"
  tags:
    - management

- name: Retrieve device groups for validation
  paloaltonetworks.panos.panos_op:
    provider: "{{ panorama_provider }}"
    cmd: "show devicegroups"
  register: devicegroups_output
  tags:
    - validation
    - always

- name: Display summary
  ansible.builtin.debug:
    msg: "Baseline config applied to {{ dg }} (template: {{ ts }})"
  tags:
    - always
